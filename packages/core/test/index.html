<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SP8D Protocol Test Harness</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* =====================
         CSS Custom Properties
         ===================== */
      :root {
        --color-bg: #f8fafd;
        --color-header-bg: #1a2233;
        --color-header-fg: #f8fafd;
        --color-header-sub: #e2e6ee;
        --color-header-desc: #b3b7be;
        --color-accent: #19c37d;
        --color-accent-hover: #159a60;
        --color-fail: #e04446;
        --color-card-bg: #fff;
        --color-card-border: rgba(25, 195, 125, 0.18);
        --color-card-hover: #f3f6fa;
        --color-metric-bg: #f3f6fa;
        --color-footer: #b3b7be;
        --font-main: "Inter", "Roboto", Arial, sans-serif;
        --font-mono: "Roboto Mono", "Menlo", "Consolas", monospace;
        --font-size-base: 1.125rem;
        --font-size-lg: 2.2rem;
        --font-size-md: 1.18rem;
        --font-size-sm: 1.01rem;
        --radius: 8px;
        --radius-sm: 4px;
        --transition: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-card: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        --space: 2.5rem;
        --space-sm: 1.5rem;
        --space-xs: 0.7rem;
      }

      /* ========== Base ========== */
      html {
        box-sizing: border-box;
        font-size: var(--font-size-base);
        background: var(--color-bg);
      }
      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }
      body {
        background: var(--color-bg);
        margin: 0;
        font-family: var(--font-main);
        color: var(--color-header-bg);
        min-height: 100vh;
        line-height: 1.7;
      }

      /* ========== Header ========== */
      header {
        background: var(--color-header-bg);
        color: var(--color-header-fg);
        padding: var(--space) var(--space) var(--space-sm) var(--space);
        border-bottom: 2px solid var(--color-accent);
        text-align: center;
        position: relative;
      }
      .header-title {
        font-size: var(--font-size-lg);
        font-weight: 700;
        letter-spacing: -0.5px;
        margin: 0 0 0.4rem 0;
        line-height: 1.1;
      }
      .header-sub {
        font-size: 1.15rem;
        font-weight: 400;
        margin: 0 0 0.5rem 0;
        color: var(--color-header-sub);
        opacity: 0.95;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
      }
      .header-desc {
        font-size: var(--font-size-sm);
        color: var(--color-header-desc);
        margin: 0;
        max-width: 700px;
        font-weight: 400;
        margin-left: auto;
        margin-right: auto;
      }
      .header-links {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: var(--space-xs);
        position: static;
      }
      .header-link {
        color: var(--color-header-desc);
        font-weight: 500;
        font-size: 1.05rem;
        text-decoration: none;
        transition: color var(--transition);
        opacity: 0.92;
      }
      .header-link:focus,
      .header-link:hover {
        color: var(--color-header-fg);
        text-decoration: none;
        opacity: 1;
      }

      /* ========== Main Layout ========== */
      main {
        max-width: 820px;
        margin: 0 auto;
        padding: var(--space) 1.5rem 0 1.5rem;
      }
      .tests {
        margin: var(--space) 0 var(--space-sm) 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space);
      }

      /* ========== Test Cards ========== */
      .testcase {
        border: 1px solid var(--color-card-border);
        border-left: 4px solid var(--color-accent);
        background: var(--color-card-bg);
        margin-bottom: 0;
        padding: var(--space-sm) var(--space-sm) 1.2rem var(--space-sm);
        border-radius: var(--radius);
        box-shadow: none;
        position: relative;
        width: 100%;
        max-width: 700px;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
        transition: background var(--transition-card);
      }
      .testcase:focus-within,
      .testcase:hover {
        background: var(--color-card-hover);
      }
      .testcase-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .testcase-header h2 {
        margin: 0;
        font-size: var(--font-size-md);
        font-weight: 600;
        color: var(--color-header-bg);
      }
      .test-desc {
        color: #3a4255;
        font-size: var(--font-size-sm);
        margin-bottom: 0.2em;
        max-width: 650px;
      }
      .runbtn {
        align-self: flex-end;
        background: var(--color-accent);
        color: #fff;
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.6em 1.5em;
        font-size: 1.05rem;
        cursor: pointer;
        font-weight: 600;
        margin-top: 0.2rem;
        margin-bottom: 0.2rem;
        transition: background var(--transition);
        box-shadow: none;
      }
      .runbtn:focus,
      .runbtn:active,
      .runbtn:hover {
        background: var(--color-accent-hover);
      }
      .runbtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ========== Metrics & Output ========== */
      .metricbar {
        margin: 0.3rem 0 0.1rem 0;
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .metric {
        font-family: var(--font-mono);
        font-size: 1.05rem;
        color: var(--color-header-bg);
        padding: 0.1rem 0.7rem 0.1rem 0.7rem;
        background: var(--color-metric-bg);
        border-radius: var(--radius-sm);
        min-width: 90px;
        text-align: center;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.5em;
      }
      .dot {
        display: inline-block;
        width: 0.75em;
        height: 0.75em;
        border-radius: 50%;
        margin-right: 0.4em;
      }
      .dot-success {
        background: var(--color-accent);
      }
      .dot-fail {
        background: var(--color-fail);
      }
      .live-output {
        background: var(--color-header-bg);
        color: var(--color-header-fg);
        font-size: var(--font-size-sm);
        padding: 0.8em 1em;
        border-radius: 6px;
        font-family: var(--font-mono);
        max-height: 100px;
        overflow: auto;
        letter-spacing: 0.01em;
        transition: background var(--transition), color var(--transition);
      }
      .success {
        color: var(--color-accent) !important;
        font-weight: 600;
      }
      .fail {
        color: var(--color-fail) !important;
        font-weight: 600;
      }
      .case-footer {
        font-size: 0.97rem;
        color: #3a4255;
        margin: 0.5em 0 0.1em 0;
        opacity: 0.7;
        font-style: italic;
      }

      /* ========== Links & Accessibility ========== */
      a {
        color: var(--color-accent);
        text-decoration: none;
        font-weight: 500;
        transition: color var(--transition);
      }
      a:focus,
      a:hover {
        color: var(--color-accent-hover);
      }
      button:focus-visible {
        outline: 2px solid var(--color-accent);
      }

      /* ========== Responsive ========== */
      @media (max-width: 700px) {
        main {
          padding: 0.5rem 0.18rem 0 0.18rem;
        }
        .testcase {
          padding: 1rem 0.8rem 0.7rem 0.7rem;
        }
        .runbtn {
          margin-left: 0.5rem;
          margin-top: 0.5rem;
          margin-bottom: 0.5rem;
        }
        .metricbar {
          flex-direction: column;
          gap: 0.6rem;
        }
        .header-links {
          position: static;
          justify-content: center;
          margin-top: var(--space-xs);
          right: 0;
          top: 0;
        }
      }

      /* ========== Utility & Misc ========== */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      footer {
        text-align: center;
        font-size: 1rem;
        color: var(--color-footer);
        margin-top: 1.2rem;
        padding: 0.7rem 0 0.3rem 0;
      }
      hr {
        margin-top: 2.8em;
        margin-bottom: 0;
        border: 0;
        border-top: 1px solid var(--color-accent);
        opacity: 0.18;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-title">SP8D Protocol — Advanced Test Harness</div>
      <div class="header-sub">
        SP8D is a high-performance, robust browser protocol for safe, lossless,
        and concurrent message passing—designed for demanding AI and data
        science copilots.
      </div>
      <div class="header-desc">
        <b>How to use:</b> Click <b>Run</b> on any test to simulate real-world
        browser concurrency scenarios. Results update live below each test.<br />
        <b>Legend:</b> <span class="dot dot-success"></span>Pass,
        <span class="dot dot-fail"></span>Fail.
      </div>
      <div class="header-links">
        <a
          class="header-link"
          href="https://github.com/SP8D/sp8d"
          target="_blank"
          >GitHub</a
        >
        <a
          class="header-link"
          href="https://www.npmjs.com/package/@sp8d/core"
          target="_blank"
          >npm</a
        >
      </div>
    </header>
    <main>
      <section
        id="diagnostics-dashboard"
        style="
          margin-bottom: 2.5rem;
          min-height: 60px;
          background: #f3f6fa;
          border: 1px solid #e2e6ee;
          border-radius: 8px;
          padding: 1rem 0 0.5rem 0;
        "
      >
        <div
          id="diag-global"
          style="
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0.7rem;
            min-height: 28px;
          "
        >
          Loading diagnostics…
        </div>
        <div
          id="diag-slotgrid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(18px, 1fr));
            gap: 2px;
            max-width: 700px;
          "
        ></div>
      </section>
      <section class="tests">
        <div class="testcase" id="case1">
          <div class="testcase-header">
            <h2>1. <b>Live High-Throughput Stress</b></h2>
            <button class="runbtn" onclick="runStressTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Simulates 5,000 message events between async
            producer and consumer, measuring actual messages processed and time
            to completion.<br />
            <b>Why It Matters:</b> Legacy <code>postMessage</code> or event bus
            patterns collapse well below this throughput. Real data science
            copilots require <b>thousands/sec without UI freezes</b>.
          </div>
          <div class="metricbar">
            <span class="metric" id="stress_result">Not run</span>
          </div>
          <div class="live-output" id="stress_output">
            Duration: - ms Lost: -
          </div>
          <div class="case-footer">
            Key metric: throughput, no missed/lost messages, no lag.
          </div>
        </div>

        <div class="testcase" id="case2">
          <div class="testcase-header">
            <h2>2. <b>Slot Reclamation & Stale-Job Handling</b></h2>
            <button class="runbtn" onclick="runReclaimTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Intentionally abandons some job slots to see if
            protocol reclaims memory/slots automatically.<br />
            <b>Why It Matters:</b> This is vital for long-running browser
            sessions&mdash;leaks or stuck jobs can creep in and kill
            reliability.
          </div>
          <div class="metricbar">
            <span class="metric" id="reclaim_result">Not run</span>
          </div>
          <div class="live-output" id="reclaim_output">
            Reclaimed: -, Errors: - Free slots after: -
          </div>
          <div class="case-footer">
            Key metric: Reclaimed slot count, protocol recovery visible in logs.
          </div>
        </div>

        <div class="testcase" id="case3">
          <div class="testcase-header">
            <h2>3. <b>Race Condition & Conflict Resolution</b></h2>
            <button class="runbtn" onclick="runRaceTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Multiple producers and consumers hammer the shared
            channel, purposely colliding on slots.
            <br />
            <b>Why It Matters:</b> Race bugs in message-passing systems are the
            #1 hidden browser reliability risk. SP8D must resolve conflicts
            cleanly.
          </div>
          <div class="metricbar">
            <span class="metric" id="race_result">Not run</span>
          </div>
          <div class="live-output" id="race_output">
            Produced: -, Consumed: -, Conflicts: -, Errors: -
          </div>
          <div class="case-footer">
            Key metric: # of resolved conflicts and error count.
          </div>
        </div>

        <div class="testcase" id="case4">
          <div class="testcase-header">
            <h2>4. <b>Protocol Correctness & Data Integrity</b></h2>
            <button class="runbtn" onclick="runCorrectTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Sends randomized messages and checks every output
            for corruption, order, duplicates, or loss.
            <br />
            <b>Why It Matters:</b> Real-world browsers lose/corrupt data under
            stress if protocol is weak—financial workflows can't tolerate this.
          </div>
          <div class="metricbar">
            <span class="metric" id="correct_result">Not run</span>
          </div>
          <div class="live-output" id="correct_output">
            Sent: -, Received: -, Fail? No
          </div>
          <div class="case-footer">
            Key metric: end-to-end message correctness, reports first failure.
          </div>
        </div>

        <div class="testcase" id="case5">
          <div class="testcase-header">
            <h2>5. <b>Slot Generation/Cycle Tag Wraparound</b></h2>
            <button class="runbtn" onclick="runGenCycleWrapTest(this)">
              ▶ Run
            </button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Repeatedly fills and drains a slot to force the
            slot generation/cycle tag (Gen/Cycle Byte) to wrap from 255 to 0.<br />
            <b>Why It Matters:</b> Ensures protocol correctness and no message
            loss or corruption even after many cycles, validating the slot
            generation logic.
          </div>
          <div class="metricbar">
            <span class="metric" id="gencycle_result">Not run</span>
          </div>
          <div class="live-output" id="gencycle_output">
            Cycles: - Errors: -
          </div>
          <div class="case-footer">
            Key metric: No protocol errors, all slots healthy after wraparound.
          </div>
        </div>
      </section>
      <hr />
    </main>
    <footer>
      <span style="font-size: 0.97rem; opacity: 0.7"
        >Review the <b>test source</b> on
        <a
          href="https://github.com/SP8D/sp8d/tree/main/packages/core/test/index.html"
          target="_blank"
          >GitHub</a
        >
        for more details.</span
      >
    </footer>
    <script type="module">
      import { registerStressScenario } from "./scenarios/stress.js";
      import { registerReclaimScenario } from "./scenarios/reclaim.js";
      import { registerRaceScenario } from "./scenarios/race.js";
      import { registerCorrectScenario } from "./scenarios/correct.js";
      import { registerGenCycleScenario } from "./scenarios/gencycle.js";
      import { encode, decode } from "./scenarios/utils.js";
      import { createChannel } from "../dist/sp8d-core.js";
      // Shared state for scenarios
      const diagSummary = {};
      const diagTestActive = { value: false };
      window.diagSummary = diagSummary;
      // Dashboard update implementation
      function updateDiagnosticsDashboard() {
        const diag = window.diagSummary || {};
        const el = document.getElementById("diag-global");
        if (!el) return;
        el.innerHTML = `
          <span class="metric">Peak Throughput: ${
            diag.peakThroughput !== undefined
              ? Math.round(diag.peakThroughput)
              : "-"
          } msg/s</span>
          <span class="metric">Avg Throughput: ${
            diag.avgThroughput !== undefined
              ? Math.round(diag.avgThroughput)
              : "-"
          } msg/s</span>
          <span class="metric">Max Lag: ${diag.maxLag ?? "-"} ms</span>
          <span class="metric">Total Conflicts: ${
            diag.totalConflicts ?? "-"
          }</span>
          <span class="metric">Total Errors: ${diag.totalErrors ?? "-"}</span>
          <span class="metric">Total Reclaimed: ${
            diag.totalReclaimed ?? "-"
          }</span>
          <span class="metric">Slots: ${diag.slots ?? "-"}</span>
        `;
        // Slot grid visualisation (optional, only if slot state is present)
        const slotGrid = document.getElementById("diag-slotgrid");
        if (
          slotGrid &&
          diag.finalSlotState &&
          Array.isArray(diag.finalSlotState)
        ) {
          slotGrid.innerHTML = diag.finalSlotState
            .map((slot, i) => {
              let color = "#e2e6ee";
              if (slot.status === 1) color = "#e04446"; // claimed
              else if (slot.status === 2) color = "#19c37d"; // ready
              else if (slot.status === 0) color = "#b3b7be"; // empty
              return `<div style="width:18px;height:18px;border-radius:3px;background:${color};border:1px solid #ccc;display:inline-block;margin:1px;" title="Slot ${i}: status ${slot.status}"></div>`;
            })
            .join("");
        }
      }
      // Register modular scenarios
      registerStressScenario({
        createChannel,
        updateDiagnosticsDashboard,
        diagSummary,
        diagTestActive,
      });
      registerReclaimScenario({
        createChannel,
        updateDiagnosticsDashboard,
        diagSummary,
        diagTestActive,
      });
      registerRaceScenario({
        createChannel,
        updateDiagnosticsDashboard,
        diagSummary,
        diagTestActive,
      });
      registerCorrectScenario({
        createChannel,
        updateDiagnosticsDashboard,
        diagSummary,
        diagTestActive,
      });
      registerGenCycleScenario({
        createChannel,
        updateDiagnosticsDashboard,
        diagSummary,
        diagTestActive,
      });
      // Initial dashboard update
      updateDiagnosticsDashboard();
    </script>
  </body>
</html>
