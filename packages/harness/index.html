<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SP8D Protocol Test Harness</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header>
      <div class="header-title">SP8D Protocol — Advanced Test Harness</div>
      <div class="header-sub">
        SP8D is a high-performance, robust browser protocol for safe, lossless,
        and concurrent message passing—designed for demanding AI and data
        science copilots.
      </div>
      <div class="header-desc">
        <b>How to use:</b> Click <b>Run</b> on any test to simulate real-world
        browser concurrency scenarios. Results update live below each test.<br />
        <b>Legend:</b> <span class="dot dot-success"></span>Pass,
        <span class="dot dot-fail"></span>Fail.
      </div>
      <nav class="header-links">
        <a
          class="header-link"
          href="https://github.com/SP8D/sp8d"
          target="_blank"
          rel="noopener"
          >GitHub</a
        >
        <a
          class="header-link"
          href="https://www.npmjs.com/package/@sp8d/core"
          target="_blank"
          rel="noopener"
          >npm</a
        >
      </nav>
    </header>
    <main>
      <section id="diagnostics-dashboard">
        <div id="diag-global">Loading diagnostics…</div>
        <div id="diag-slotgrid"></div>
      </section>
      <section class="carousel-container">
        <div
          class="carousel-overlay carousel-overlay-left"
          aria-hidden="true"
        ></div>
        <button
          class="carousel-chevron-btn carousel-chevron-left"
          tabindex="0"
          role="button"
          aria-label="Previous Test"
          id="carousel-prev"
          type="button"
        >
          <svg
            width="28"
            height="28"
            viewBox="0 0 28 28"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path d="M18 6L10 14L18 22" />
          </svg>
        </button>
        <div class="carousel-track" id="carousel-track"></div>
        <div
          class="carousel-overlay carousel-overlay-right"
          aria-hidden="true"
        ></div>
        <button
          class="carousel-chevron-btn carousel-chevron-right"
          tabindex="0"
          role="button"
          aria-label="Next Test"
          id="carousel-next"
          type="button"
        >
          <svg
            width="28"
            height="28"
            viewBox="0 0 28 28"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path d="M10 6L18 14L10 22" />
          </svg>
        </button>
      </section>
      <!-- The original .tests section will be moved into .carousel-track by JS -->
      <section class="tests" style="display: none">
        <div class="testcase" id="live-high-throughput-stress">
          <div class="testcase-header">
            <h2>1. <b>Live High-Throughput Stress</b></h2>
            <button class="runbtn" onclick="runStressTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Simulates 5,000 message events between async
            producer and consumer, measuring actual messages processed and time
            to completion.<br />
            <b>Why It Matters:</b> Legacy <code>postMessage</code> or event bus
            patterns collapse well below this throughput. Real data science
            copilots require <b>thousands/sec without UI freezes</b>.
          </div>
          <div class="metricbar">
            <span class="metric" id="stress_result">Not run</span>
          </div>
          <div class="live-output" id="stress_output">
            Duration: - ms Lost: -
          </div>
          <div class="case-footer">
            Key metric: throughput, no missed/lost messages, no lag.
          </div>
        </div>

        <div class="testcase" id="slot-reclamation-stale-job-handling">
          <div class="testcase-header">
            <h2>2. <b>Slot Reclamation & Stale-Job Handling</b></h2>
            <button class="runbtn" onclick="runReclaimTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Intentionally abandons some job slots to see if
            protocol reclaims memory/slots automatically.<br />
            <b>Why It Matters:</b> This is vital for long-running browser
            sessions&mdash;leaks or stuck jobs can creep in and kill
            reliability.
          </div>
          <div class="metricbar">
            <span class="metric" id="reclaim_result">Not run</span>
          </div>
          <div class="live-output" id="reclaim_output">
            Reclaimed: -, Errors: - Free slots after: -
          </div>
          <div class="case-footer">
            Key metric: Reclaimed slot count, protocol recovery visible in logs.
          </div>
        </div>

        <div class="testcase" id="race-condition-conflict-resolution">
          <div class="testcase-header">
            <h2>3. <b>Race Condition & Conflict Resolution</b></h2>
            <button class="runbtn" onclick="runRaceTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Multiple producers and consumers hammer the shared
            channel, purposely colliding on slots.
            <br />
            <b>Why It Matters:</b> Race bugs in message-passing systems are the
            #1 hidden browser reliability risk. SP8D must resolve conflicts
            cleanly.
          </div>
          <div class="metricbar">
            <span class="metric" id="race_result">Not run</span>
          </div>
          <div class="live-output" id="race_output">
            Produced: -, Consumed: -, Conflicts: -, Errors: -
          </div>
          <div class="case-footer">
            Key metric: # of resolved conflicts and error count.
          </div>
        </div>

        <div class="testcase" id="protocol-correctness-data-integrity">
          <div class="testcase-header">
            <h2>4. <b>Protocol Correctness & Data Integrity</b></h2>
            <button class="runbtn" onclick="runCorrectTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Sends randomized messages and checks every output
            for corruption, order, duplicates, or loss.
            <br />
            <b>Why It Matters:</b> Real-world browsers lose/corrupt data under
            stress if protocol is weak—financial workflows can't tolerate this.
          </div>
          <div class="metricbar">
            <span class="metric" id="correct_result">Not run</span>
          </div>
          <div class="live-output" id="correct_output">
            Sent: -, Received: -, Fail? No
          </div>
          <div class="case-footer">
            Key metric: end-to-end message correctness, reports first failure.
          </div>
        </div>

        <div class="testcase" id="slot-generation-cycle-tag-wraparound">
          <div class="testcase-header">
            <h2>5. <b>Slot Generation/Cycle Tag Wraparound</b></h2>
            <button class="runbtn" onclick="runGenCycleWrapTest(this)">
              ▶ Run
            </button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Repeatedly fills and drains a slot to force the
            slot generation/cycle tag (Gen/Cycle Byte) to wrap from 255 to 0.<br />
            <b>Why It Matters:</b> Ensures protocol correctness and no message
            loss or corruption even after many cycles, validating the slot
            generation logic.
          </div>
          <div class="metricbar">
            <span class="metric" id="gencycle_result">Not run</span>
          </div>
          <div class="live-output" id="gencycle_output">
            Cycles: - Errors: -
          </div>
          <div class="case-footer">
            Key metric: No protocol errors, all slots healthy after wraparound.
          </div>
        </div>

        <div class="testcase" id="dos-flood-resilience">
          <div class="testcase-header">
            <h2>6. <b>DoS/Flood Resilience</b></h2>
            <button class="runbtn" onclick="runDosTest(this)">▶ Run</button>
          </div>
          <div class="test-desc">
            <b>Scenario:</b> Floods the channel with 50,000+ messages as fast as
            possible, simulating a denial-of-service or buggy producer.<br />
            <b>Why It Matters:</b> Validates protocol stability, error handling,
            and resource usage under extreme load. Ensures no crash, memory
            leak, or starvation of legitimate consumers.
          </div>
          <div class="metricbar">
            <span class="metric" id="dos_result">Not run</span>
          </div>
          <div class="live-output" id="dos_output">
            Duration: - ms Lost: - Send errors: -
          </div>
          <div class="case-footer">
            Key metric: No crash, no memory leak, no starvation, error count.
          </div>
        </div>
      </section>
      <hr />
    </main>
    <footer>
      <span class="footer-note">
        Review the <b>test source</b> on
        <a
          href="https://github.com/SP8D/sp8d/tree/main/packages/harness/index.html"
          target="_blank"
          rel="noopener"
          >GitHub</a
        >
        for more details.
      </span>
    </footer>
    <script type="module" src="./main.js"></script>
  </body>
</html>
